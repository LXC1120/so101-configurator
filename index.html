<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èˆµæœºé…ç½®å·¥å…·ï¼ˆWeb Serialï¼‰</title>
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;max-width:980px;margin:0 auto;padding:18px;line-height:1.45}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:0 0 10px}
    .card{border:1px solid rgba(127,127,127,.25);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{display:flex;gap:8px;align-items:center}
    input,select,button{font:inherit}
    input,select{padding:8px 10px;border-radius:10px;border:1px solid rgba(127,127,127,.35)}
    input{width:120px}
    button{padding:10px 14px;border-radius:12px;border:1px solid rgba(127,127,127,.35);cursor:pointer}
    button:disabled{opacity:.45;cursor:not-allowed}
    .small{font-size:12px;opacity:.85}
    .pill{display:inline-block;padding:2px 10px;border:1px solid rgba(127,127,127,.35);border-radius:999px}
    .ok{color:#0a7a2f}
    .warn{color:#b45309}
    .bad{color:#b91c1c}
    pre{background:rgba(0,0,0,.85);color:#e8eefc;padding:12px;border-radius:14px;overflow:auto;max-height:360px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid rgba(127,127,127,.25);padding:6px 8px;text-align:left;font-size:13px}
    th{opacity:.9}
  </style>
</head>
<body>
  <h1>èˆµæœºé…ç½®å·¥å…·ï¼ˆWeb Serial / æ¡Œé¢ Chromeï¼‰</h1>
  <div class="small">
    <span class="pill" id="statusPill">æœªè¿æ¥</span>
    <span class="pill">å»ºè®®ï¼šä¸€æ¬¡åªæ¥ 1 ä¸ªèˆµæœºï¼›èˆµæœºéœ€å¤–æ¥ç”µæºï¼›TX/RX äº¤å‰ï¼›GND å…±åœ°</span>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="btnConnect">è¿æ¥ä¸²å£</button>
        <button id="btnDisconnect" disabled>æ–­å¼€</button>
      </div>
      <label>æ³¢ç‰¹ç‡ <input id="baud" inputmode="numeric" value="1000000"/></label>
    </div>
    <p class="small warn" style="margin:10px 0 0">Web Serial ä»…åœ¨ HTTPSï¼ˆæˆ– http://localhostï¼‰å¯ç”¨ï¼›è¯·ä½¿ç”¨æ¡Œé¢ç‰ˆ Chrome/Edgeã€‚</p>
  </div>

  <div class="grid">
    <div class="card">
      <h2>æµæ°´çº¿é…ç½®ï¼ˆè‡ªåŠ¨ç›‘æ§æ’æ‹”ï¼‰</h2>
      <div class="row">
        <label>èµ·å§‹ID <input id="pipeStart" inputmode="numeric" value="1" /></label>
        <label>ç»“æŸID <input id="pipeEnd" inputmode="numeric" value="6" /></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnPipeStart" disabled>å¼€å§‹æµæ°´çº¿</button>
        <button id="btnPipeStop" disabled>ä¸­æ–­</button>
        <span class="pill" id="pipeState">æœªè¿è¡Œ</span>
      </div>
      <p class="small">ç‚¹å‡»â€œå¼€å§‹æµæ°´çº¿â€åï¼Œä½ åªéœ€è¦æ’æ‹”èˆµæœºï¼šæ£€æµ‹åˆ°æ’å…¥â†’æŒ‰é¡ºåºå†™å…¥â†’éªŒè¯â†’ç­‰å¾…æ‹”æ‰â†’è¿›å…¥ä¸‹ä¸€åªã€‚</p>
    </div>

    <div class="card">
      <h2>å•ç‹¬ä¿®æ”¹ ID</h2>
      <div class="row">
        <label>ç›®æ ‡æ–°ID <input id="newId" inputmode="numeric" value="1" /></label>
        <button id="btnDoChange" disabled>å¼€å§‹æ”¹å·</button>
        <button id="btnPingBroadcast" disabled>Ping å¹¿æ’­(0xFE)</button>
      </div>
      <p class="small">æµç¨‹ï¼šè§£é”â†’å…³æ‰­åŠ›â†’å†™IDâ†’ä¸Šé”â†’éªŒè¯ã€‚</p>
    </div>

    <div class="card">
      <h2>æ‰«æèˆµæœºï¼ˆå‘ç°åœ¨çº¿ IDï¼‰</h2>
      <div class="row">
        <label>æ‰«æèµ·å§‹ <input id="scanStart" inputmode="numeric" value="1"/></label>
        <label>æ‰«æç»“æŸ <input id="scanEnd" inputmode="numeric" value="20"/></label>
        <label>å‘¨æœŸms <input id="scanPeriod" inputmode="numeric" value="800"/></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnScanStart" disabled>å¼€å§‹æ‰«æ</button>
        <button id="btnScanStop" disabled>åœæ­¢æ‰«æ</button>
        <span class="pill" id="scanState">æœªè¿è¡Œ</span>
      </div>
      <p class="small">æ‰«æåªè´Ÿè´£â€œæœ‰å“ªäº›IDåœ¨çº¿â€ã€‚ä½ç½®ä¿¡æ¯åˆ·æ–°åœ¨ä¸‹é¢å•ç‹¬æ§åˆ¶ã€‚</p>
    </div>

    <div class="card">
      <h2>å®æ—¶ä½ç½®ï¼ˆå¯å¼€å…³ï¼‰</h2>
      <div class="row">
        <label>åˆ·æ–°ms <input id="posPeriod" inputmode="numeric" value="50"/></label>
        <button id="btnPosStart" disabled>å¼€å§‹å®æ—¶ä½ç½®</button>
        <button id="btnPosStop" disabled>åœæ­¢</button>
        <span class="pill" id="posState">æœªè¿è¡Œ</span>
      </div>
      <p class="small">å¯¹â€œæ‰«æåˆ°çš„åœ¨çº¿èˆµæœºåˆ—è¡¨â€è¿›è¡Œä½ç½®åˆ·æ–°ï¼ˆæ›´å¿«çš„åšæ³•æ˜¯ SYNC READï¼Œåç»­å¯å†åŠ ï¼‰ã€‚</p>
    </div>

    <div class="card">
      <h2>åŠ¨ä½œå·¥å…·</h2>
      <div class="row">
        <label>ç›®æ ‡ID <input id="actId" inputmode="numeric" value="1"/></label>
        <button id="btnMiddle" disabled>å†™ 0x28(40)=128ï¼ˆä¸­å€¼æ ¡å‡†ï¼‰</button>
        <button id="btnResetState" disabled>çŠ¶æ€é‡ç½® RESET(0x0A)</button>
      </div>
      <p class="small">ä½ è¯´çš„â€œé‡ç½®ä¸­ç½®ä½â€æŒ‰ä½ çš„å®šä¹‰å®ç°ä¸ºï¼šå†™ 40 å·åœ°å€=128ã€‚</p>
    </div>
  </div>

  <div class="card">
    <h2>åœ¨çº¿èˆµæœºåˆ—è¡¨</h2>
    <table>
      <thead><tr><th>ID</th><th>åœ¨çº¿</th><th>ä½ç½®</th><th>é€Ÿåº¦</th><th>è´Ÿè½½</th><th>ç”µå‹</th><th>æ¸©åº¦</th><th>æ›´æ–°æ—¶é—´</th></tr></thead>
      <tbody id="scanTableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>æ—¥å¿—</h2>
    <pre id="log"></pre>
    <div class="row small" style="justify-content:space-between;margin-top:10px">
      <span>æç¤ºï¼šæµè§ˆå™¨ä¼šå¼¹çª—è®©ä½ é€‰æ‹©ä¸²å£è®¾å¤‡ï¼Œè¿™æ˜¯æ­£å¸¸æƒé™æœºåˆ¶ã€‚</span>
      <button id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>
    </div>
  </div>

<script>
(() => {
  // ====== å¸¸é‡ï¼ˆä¸ä½ è„šæœ¬ä¸€è‡´ï¼‰======
  const BROADCAST_ID = 0xFE;
  const ADDR_ID     = 0x05;
  const ADDR_LOCK   = 0x37;
  const ADDR_TORQUE = 0x28; // 40

  // çŠ¶æ€
  let port=null, writer=null, reader=null, readLoopRunning=false;
  let rxBuf=[];

  // åœ¨çº¿è®¾å¤‡è¡¨ï¼šid -> {online, pos, spd, load, volt, temp, ts}
  const devices = new Map(); // åªç»´æŠ¤æ‰«æè¿‡/å‘ç°çš„

  // UI
  const logEl = document.getElementById('log');
  const statusPill = document.getElementById('statusPill');

  const btnConnect = document.getElementById('btnConnect');
  const btnDisconnect = document.getElementById('btnDisconnect');
  const baudEl = document.getElementById('baud');

  const newIdEl = document.getElementById('newId');
  const btnDoChange = document.getElementById('btnDoChange');
  const btnPingBroadcast = document.getElementById('btnPingBroadcast');

  const pipeStartEl = document.getElementById('pipeStart');
  const pipeEndEl = document.getElementById('pipeEnd');
  const btnPipeStart = document.getElementById('btnPipeStart');
  const btnPipeStop = document.getElementById('btnPipeStop');
  const pipeStateEl = document.getElementById('pipeState');

  const scanStartEl = document.getElementById('scanStart');
  const scanEndEl = document.getElementById('scanEnd');
  const scanPeriodEl = document.getElementById('scanPeriod');
  const btnScanStart = document.getElementById('btnScanStart');
  const btnScanStop = document.getElementById('btnScanStop');
  const scanStateEl = document.getElementById('scanState');

  const posPeriodEl = document.getElementById('posPeriod');
  const btnPosStart = document.getElementById('btnPosStart');
  const btnPosStop = document.getElementById('btnPosStop');
  const posStateEl = document.getElementById('posState');

  const scanTableBody = document.getElementById('scanTableBody');

  const actIdEl = document.getElementById('actId');
  const btnMiddle = document.getElementById('btnMiddle');
  const btnResetState = document.getElementById('btnResetState');

  const btnClearLog = document.getElementById('btnClearLog');

  function setStatus(text, kind="") {
    statusPill.textContent = text;
    statusPill.className = "pill " + kind;
  }
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ====== åè®®ï¼šæ ¡éªŒä¸ç»„åŒ… ======
  function calcChecksum(dataBytes) {
    let sum=0;
    for (const b of dataBytes) sum += (b & 0xFF);
    return (~sum) & 0xFF;
  }
  function buildPacket(dataBytes) {
    const chk = calcChecksum(dataBytes);
    return new Uint8Array([0xFF, 0xFF, ...dataBytes, chk]);
  }

  async function ensureWriter(){
    if (!port) throw new Error("æœªè¿æ¥ä¸²å£");
    if (!writer) writer = port.writable.getWriter();
  }
  async function writeRaw(u8){
    await ensureWriter();
    await writer.write(u8);
  }

  // ====== è¯»å–ï¼šç¼“å­˜æ”¶åˆ°çš„å­—èŠ‚ ======
  async function startReadLoop(){
    reader = port.readable.getReader();
    readLoopRunning = true;
    rxBuf = [];
    (async () => {
      try{
        while (readLoopRunning){
          const {value, done} = await reader.read();
          if (done) break;
          if (value && value.length){
            for (const b of value) rxBuf.push(b);
            if (rxBuf.length > 8192) rxBuf = rxBuf.slice(-4096);
          }
        }
      } catch(e){
        log(`è¯»å–å¼‚å¸¸: ${e.message || e}`);
      }
    })();
  }
  async function stopReadLoop(){
    readLoopRunning = false;
    if (reader){
      try{ await reader.cancel(); } catch{}
      try{ reader.releaseLock(); } catch{}
      reader = null;
    }
    rxBuf=[];
  }

  // ====== å¸§è§£æï¼šä» rxBuf ä¸­æŠ½å–ä¸€å¸§ ======
  function tryPopFrameFromRxBuf(){
    // å¸§æ ¼å¼ï¼šFF FF ID LEN ERROR ... CHK
    for (let i=0; i+6<=rxBuf.length; i++){
      if (rxBuf[i]!==0xFF || rxBuf[i+1]!==0xFF) continue;
      const id = rxBuf[i+2];
      const len = rxBuf[i+3];
      const total = 2 + 1 + 1 + len; // FF FF + ID + LEN + (len bytes: ERROR..CHK)
      if (i+total > rxBuf.length) return null;
      const frame = rxBuf.slice(i, i+total);
      rxBuf = rxBuf.slice(i+total);
      return {id, len, frame};
    }
    // å¦‚æœæ²¡æ‰¾åˆ°å¸§å¤´ï¼Œä¸¢å¼ƒä¸€éƒ¨åˆ†ç¼“å†²é¿å…æ— é™å¢é•¿
    if (rxBuf.length > 4096) rxBuf = rxBuf.slice(-1024);
    return null;
  }

  // ====== åŸºæœ¬æŒ‡ä»¤ ======
  async function ping(targetId, timeoutMs=120){
    const data = [targetId & 0xFF, 0x02, 0x01];
    const pkt = buildPacket(data);
    rxBuf = [];
    await writeRaw(pkt);

    const start = performance.now();
    while (performance.now() - start < timeoutMs){
      const fr = tryPopFrameFromRxBuf();
      if (fr) return true;
      await sleep(5);
    }
    return false;
  }

  async function writeReg(targetId, address, value){
    const data = [targetId & 0xFF, 0x04, 0x03, address & 0xFF, value & 0xFF];
    const pkt = buildPacket(data);
    rxBuf = [];
    await writeRaw(pkt);
    await sleep(50);
  }

  async function readReg(targetId, address, size, timeoutMs=80){
    // READ DATA: ID LEN INST(0x02) ADDR SIZE
    const data = [targetId & 0xFF, 0x04, 0x02, address & 0xFF, size & 0xFF];
    const pkt = buildPacket(data);
    rxBuf = [];
    await writeRaw(pkt);

    const start = performance.now();
    while (performance.now() - start < timeoutMs){
      const fr = tryPopFrameFromRxBuf();
      if (!fr) { await sleep(2); continue; }
      // fr.frame: [FF,FF,ID,LEN,ERR, ...params, CHK]
      const frame = fr.frame;
      const err = frame[4];
      if (err !== 0) return null;
      const paramsLen = frame[3] - 2; // LEN - (ERR + CHK)
      const params = frame.slice(5, 5 + paramsLen);
      return params;
    }
    return null;
  }

  // ====== å•æ¬¡æ”¹å·ï¼ˆä¸¥æ ¼æŒ‰ä½ çš„è„šæœ¬é¡ºåºï¼‰======
  async function changeIdLikeScript(newId){
    newId = Number(newId);
    if (!(newId>=1 && newId<=253)) throw new Error("ID èŒƒå›´ 1~253");

    log(`å¼€å§‹æ”¹å·ï¼šç›®æ ‡æ–° ID=${newId}`);

    // A è§£é”ï¼ˆå¹¿æ’­ï¼‰
    await writeReg(BROADCAST_ID, ADDR_LOCK, 0);
    // B å…³æ‰­åŠ›ï¼ˆå¹¿æ’­ï¼‰
    await writeReg(BROADCAST_ID, ADDR_TORQUE, 0);
    // C å†™IDï¼ˆå¹¿æ’­ï¼‰
    await writeReg(BROADCAST_ID, ADDR_ID, newId);
    await sleep(150);
    // D ä¸Šé”ï¼ˆå¯¹æ–°IDï¼‰
    await writeReg(newId, ADDR_LOCK, 1);

    // éªŒè¯
    log(`éªŒè¯ï¼šPING ID=${newId} ...`);
    let ok = await ping(newId, 180);
    if (!ok){
      await sleep(500);
      ok = await ping(newId, 180);
    }
    if (!ok) throw new Error("éªŒè¯å¤±è´¥ï¼ˆè¯·æ£€æŸ¥ä¾›ç”µ/çº¿åº/æ³¢ç‰¹ç‡ï¼‰");
    log("âœ… æ”¹å·æˆåŠŸ");
  }

  // ====== æµæ°´çº¿ï¼šè‡ªåŠ¨ç›‘æ§æ’æ‹” ======
  let pipeRunning=false;
  let pipeTarget=1, pipeStart=1, pipeEnd=6;
  let pipeState="IDLE"; // WAIT_INSERT | PROGRAMMING | WAIT_REMOVE
  let pipeLastSeen=false;
  let pipeLostSince=null;
  let pipeTimer=null;

  async function pipeTick(){
    if (!pipeRunning) return;

    if (pipeState==="WAIT_INSERT"){
      const seen = await ping(BROADCAST_ID, 120);
      if (seen && !pipeLastSeen){
        pipeLastSeen = true;
        pipeState = "PROGRAMMING";
        pipeStateEl.textContent = `æ£€æµ‹åˆ°æ’å…¥ï¼Œé…ç½® ID=${pipeTarget}...`;
      } else if (!seen){
        pipeLastSeen = false;
      }
      return;
    }

    if (pipeState==="PROGRAMMING"){
      await changeIdLikeScript(pipeTarget);
      pipeState = "WAIT_REMOVE";
      pipeLostSince = null;
      pipeStateEl.textContent = `å·²å†™å…¥ ID=${pipeTarget}ï¼Œè¯·æ‹”æ‰èˆµæœº...`;
      return;
    }

    if (pipeState==="WAIT_REMOVE"){
      const online = await ping(pipeTarget, 120);
      if (online){
        pipeLostSince = null;
      } else {
        if (pipeLostSince==null) pipeLostSince = performance.now();
        else if (performance.now() - pipeLostSince >= 1000){
          // ç¡®è®¤æ‹”æ‰
          if (pipeTarget >= pipeEnd){
            log(`ğŸ‰ æµæ°´çº¿å®Œæˆï¼š${pipeStart}~${pipeEnd}`);
            pipeStateEl.textContent = `å®Œæˆï¼š${pipeStart}~${pipeEnd}`;
            stopPipeline();
            return;
          }
          pipeTarget += 1;
          pipeState = "WAIT_INSERT";
          pipeLastSeen = false;
          pipeStateEl.textContent = `ç­‰å¾…æ’å…¥ä¸‹ä¸€åªï¼Œç›®æ ‡ ID=${pipeTarget}...`;
          log(`è¯·æ’å…¥ä¸‹ä¸€åªèˆµæœºï¼Œç›®æ ‡ ID=${pipeTarget}`);
        }
      }
    }
  }

  function startPipeline(){
    pipeStart = Number(pipeStartEl.value);
    pipeEnd = Number(pipeEndEl.value);
    if (!Number.isFinite(pipeStart) || !Number.isFinite(pipeEnd)) { alert("ID èŒƒå›´ä¸åˆæ³•"); return; }
    if (pipeStart<1 || pipeEnd>253 || pipeStart>pipeEnd){ alert("ID èŒƒå›´åº”åœ¨ 1~253 ä¸” èµ·å§‹<=ç»“æŸ"); return; }

    pipeRunning = true;
    pipeTarget = pipeStart;
    pipeState = "WAIT_INSERT";
    pipeLastSeen = false;
    pipeLostSince = null;

    btnPipeStart.disabled = true;
    btnPipeStop.disabled = false;
    pipeStateEl.textContent = `è¿è¡Œä¸­ï¼šç­‰å¾…æ’å…¥ç¬¬ä¸€åªï¼ˆç›®æ ‡ ID=${pipeTarget}ï¼‰...`;
    log(`æµæ°´çº¿å¯åŠ¨ï¼šå°†é…ç½® ID=${pipeStart}~${pipeEnd}ã€‚è¯·æ’å…¥ç¬¬ä¸€åªèˆµæœº...`);

    if (pipeTimer) clearInterval(pipeTimer);
    pipeTimer = setInterval(() => {
      pipeTick().catch(e => {
        log(`æµæ°´çº¿å¼‚å¸¸: ${e.message || e}`);
        pipeStateEl.textContent = "å¼‚å¸¸åœæ­¢";
        stopPipeline();
      });
    }, 120);
  }

  function stopPipeline(){
    pipeRunning = false;
    if (pipeTimer){ clearInterval(pipeTimer); pipeTimer=null; }
    btnPipeStart.disabled = !port;
    btnPipeStop.disabled = true;
    if (pipeStateEl.textContent.startsWith("å®Œæˆ")) return;
    pipeStateEl.textContent = "æœªè¿è¡Œ";
  }

  // ====== æ‰«æï¼šåªå‘ç°åœ¨çº¿ ID ======
  let scanRunning=false, scanTimer=null;

  function renderTable(){
    const ids = Array.from(devices.keys()).sort((a,b)=>a-b);
    scanTableBody.innerHTML = ids.map(id=>{
      const d = devices.get(id);
      const online = d.online ? "âœ…" : "";
      const pos = d.pos ?? "";
      const spd = d.spd ?? "";
      const load = d.load ?? "";
      const volt = d.volt ?? "";
      const temp = d.temp ?? "";
      const ts = d.ts ? new Date(d.ts).toLocaleTimeString() : "";
      return `<tr>
        <td>${id}</td><td>${online}</td>
        <td>${pos}</td><td>${spd}</td><td>${load}</td><td>${volt}</td><td>${temp}</td><td>${ts}</td>
      </tr>`;
    }).join("");
  }

  async function scanOnce(){
    const start = Number(scanStartEl.value);
    const end = Number(scanEndEl.value);
    if (!Number.isFinite(start)||!Number.isFinite(end)||start<1||end>253||start>end) return;

    for (let id=start; id<=end; id++){
      const ok = await ping(id, 40);
      if (!devices.has(id)) devices.set(id, {online:false});
      const d = devices.get(id);
      d.online = ok;
      if (!ok){
        // ç¦»çº¿æ—¶ä¸æ¸…ç©ºä¸Šæ¬¡å€¼ï¼Œæ–¹ä¾¿è§‚å¯Ÿ
      }
    }
    renderTable();
  }

  function startScan(){
    scanRunning = true;
    btnScanStart.disabled = true;
    btnScanStop.disabled = false;
    scanStateEl.textContent = "æ‰«æï¼šè¿è¡Œä¸­";
    const period = Math.max(200, Number(scanPeriodEl.value)||800);
    scanOnce().catch(()=>{});
    scanTimer = setInterval(() => scanOnce().catch(()=>{}), period);
  }
  function stopScan(){
    scanRunning=false;
    if (scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    btnScanStart.disabled = !port;
    btnScanStop.disabled = true;
    scanStateEl.textContent = "æ‰«æï¼šå·²åœæ­¢";
  }

  // ====== å®æ—¶ä½ç½®ï¼šå¯å¼€å…³ï¼ˆåŸºäºå·²æ‰«æåˆ°çš„åœ¨çº¿è®¾å¤‡ï¼‰======
  let posRunning=false, posTimer=null;

  async function refreshPositionsOnce(){
    // è¯» 0x38 èµ· 8 å­—èŠ‚ï¼špos(2) spd(2) load(2) volt(1) temp(1)
    const onlineIds = Array.from(devices.keys()).filter(id => devices.get(id).online);
    for (const id of onlineIds){
      const params = await readReg(id, 0x38, 8, 35);
      if (!params || params.length < 8) continue;

      const pos = params[0] | (params[1]<<8);
      const spd = params[2] | (params[3]<<8);
      const load = params[4] | (params[5]<<8);
      const volt = params[6];
      const temp = params[7];

      const d = devices.get(id);
      d.pos = pos;
      d.spd = spd;
      d.load = load;
      d.volt = volt;
      d.temp = temp;
      d.ts = Date.now();
    }
    renderTable();
  }

  function startPos(){
    posRunning=true;
    btnPosStart.disabled = true;
    btnPosStop.disabled = false;
    posStateEl.textContent = "å®æ—¶ä½ç½®ï¼šè¿è¡Œä¸­";
    const period = Math.max(20, Number(posPeriodEl.value)||50);
    refreshPositionsOnce().catch(()=>{});
    posTimer = setInterval(() => refreshPositionsOnce().catch(()=>{}), period);
  }
  function stopPos(){
    posRunning=false;
    if (posTimer){ clearInterval(posTimer); posTimer=null; }
    btnPosStart.disabled = !port;
    btnPosStop.disabled = true;
    posStateEl.textContent = "å®æ—¶ä½ç½®ï¼šå·²åœæ­¢";
  }

  // ====== åŠ¨ä½œå·¥å…· ======
  async function writeMiddleCalibrate(id){
    // æŒ‰ä½ çš„å®šä¹‰ï¼šå†™ 0x28(40)=128
    await writeReg(id, 0x28, 128);
    await sleep(50);
  }

  async function resetState(id){
    // RESET æŒ‡ä»¤ 0x0Aï¼šFF FF ID 02 0x0A CHK
    const data = [id & 0xFF, 0x02, 0x0A];
    const pkt = buildPacket(data);
    rxBuf = [];
    await writeRaw(pkt);
    await sleep(80);
  }

  // ====== UI ç»‘å®š ======
  btnClearLog.onclick = () => { logEl.textContent = ""; };

  function setUiConnected(connected){
    btnConnect.disabled = connected;
    btnDisconnect.disabled = !connected;
    baudEl.disabled = connected;

    btnPipeStart.disabled = !connected;
    btnPipeStop.disabled = true;

    btnDoChange.disabled = !connected;
    btnPingBroadcast.disabled = !connected;

    btnScanStart.disabled = !connected;
    btnScanStop.disabled = true;

    btnPosStart.disabled = !connected;
    btnPosStop.disabled = true;

    btnMiddle.disabled = !connected;
    btnResetState.disabled = !connected;

    if (!connected) setStatus("æœªè¿æ¥");
    else setStatus("å·²è¿æ¥", "ok");
  }

  btnConnect.onclick = async () => {
    try{
      if (!("serial" in navigator)){
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Serialã€‚è¯·ä½¿ç”¨æ¡Œé¢ç‰ˆ Chrome/Edgeã€‚");
        return;
      }
      const baudRate = Number(baudEl.value || "1000000");
      if (!Number.isFinite(baudRate) || baudRate <= 0){
        alert("æ³¢ç‰¹ç‡ä¸åˆæ³•");
        return;
      }
      port = await navigator.serial.requestPort();
      await port.open({ baudRate });
      await startReadLoop();
      setUiConnected(true);
      log(`å·²è¿æ¥ä¸²å£ï¼Œbaud=${baudRate}`);
    } catch(e){
      log(`è¿æ¥å¤±è´¥: ${e.message || e}`);
      setUiConnected(false);
      port = null;
    }
  };

  btnDisconnect.onclick = async () => {
    try{
      stopPipeline();
      stopScan();
      stopPos();
      await stopReadLoop();
      if (writer){ try{ writer.releaseLock(); } catch{} writer=null; }
      if (port){ await port.close(); }
      port=null;
      setUiConnected(false);
      log("å·²æ–­å¼€ä¸²å£");
    } catch(e){
      log(`æ–­å¼€å¤±è´¥: ${e.message || e}`);
    }
  };

  btnPingBroadcast.onclick = async () => {
    try{
      const ok = await ping(BROADCAST_ID, 150);
      log(ok ? "å¹¿æ’­ PINGï¼šæ£€æµ‹åˆ°å›åŒ…" : "å¹¿æ’­ PINGï¼šæœªæ£€æµ‹åˆ°å›åŒ…");
    } catch(e){
      log(`å¹¿æ’­ PING å¤±è´¥: ${e.message || e}`);
    }
  };

  btnDoChange.onclick = async () => {
    try{
      btnDoChange.disabled = true;
      await changeIdLikeScript(newIdEl.value);
    } catch(e){
      log(`æ”¹å·å¤±è´¥: ${e.message || e}`);
    } finally {
      btnDoChange.disabled = !port;
    }
  };

  btnPipeStart.onclick = () => startPipeline();
  btnPipeStop.onclick = () => { stopPipeline(); log("æµæ°´çº¿å·²ä¸­æ–­"); };

  btnScanStart.onclick = () => startScan();
  btnScanStop.onclick = () => stopScan();

  btnPosStart.onclick = () => startPos();
  btnPosStop.onclick = () => stopPos();

  btnMiddle.onclick = async () => {
    try{
      const id = Number(actIdEl.value);
      if (!Number.isFinite(id) || id<0 || id>253) throw new Error("ç›®æ ‡ ID ä¸åˆæ³•");
      log(`å†™ 0x28(40)=128ï¼šID=${id}`);
      await writeMiddleCalibrate(id);
      log("âœ… å†™å…¥å®Œæˆ");
    } catch(e){
      log(`å†™å…¥å¤±è´¥: ${e.message || e}`);
    }
  };

  btnResetState.onclick = async () => {
    try{
      const id = Number(actIdEl.value);
      if (!Number.isFinite(id) || id<0 || id>253) throw new Error("ç›®æ ‡ ID ä¸åˆæ³•");
      log(`RESET(0x0A)ï¼šID=${id}`);
      await resetState(id);
      log("âœ… å·²å‘é€ RESET");
    } catch(e){
      log(`RESET å¤±è´¥: ${e.message || e}`);
    }
  };

  // åˆå§‹
  setUiConnected(false);
})();
</script>
</body>
</html>
