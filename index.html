<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èˆµæœºé…ç½®å·¥å…·V8.1ï¼ˆWeb Serial / æ¡Œé¢ Chromeï¼‰</title>
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",sans-serif;max-width:1200px;margin:0 auto;padding:16px;line-height:1.45}
    a{color:inherit}
    h1{font-size:18px;margin:0}
    h2{font-size:15px;margin:0 0 10px}
    .small{font-size:12px;opacity:.85}
    .pill{display:inline-block;padding:2px 10px;border:1px solid rgba(127,127,127,.35);border-radius:999px}
    .ok{color:#0a7a2f}
    .warn{color:#b45309}
    .btn{padding:8px 10px;border-radius:12px;border:1px solid rgba(127,127,127,.35);cursor:pointer;background:transparent}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    input{padding:7px 9px;border-radius:10px;border:1px solid rgba(127,127,127,.35);font:inherit}
    .mini{width:86px}
    .card{border:1px solid rgba(127,127,127,.25);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .header{position:sticky;top:0;z-index:10;background:Canvas;border-bottom:1px solid rgba(127,127,127,.18);padding:10px 0;margin-bottom:14px}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .leftTitle{display:flex;flex-direction:column;gap:4px}
    .rightConnect{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .layout{display:grid;grid-template-columns:330px 1fr;gap:14px;align-items:start}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid rgba(127,127,127,.22);padding:7px 8px;text-align:left;font-size:13px;vertical-align:middle}
    th{opacity:.9}
    pre{background:rgba(0,0,0,.85);color:#e8eefc;padding:12px;border-radius:16px;overflow:auto;max-height:280px;margin:0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .qrWrap{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
    .qr{width:120px;height:120px;border-radius:14px;border:1px solid rgba(127,127,127,.25);display:block;object-fit:cover;background:rgba(127,127,127,.15)}
    .muted{opacity:.85}
    dialog{border:none;border-radius:18px;padding:0;max-width:min(720px,92vw);box-shadow:0 12px 40px rgba(0,0,0,.3)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal{padding:14px}
    .modalHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
    .modalGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.modalGrid{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <div class="header">
    <div class="header-inner">
      <div class="leftTitle">
        <h1>èˆµæœºé…ç½®å·¥å…·V8.1ï¼ˆWeb Serial / æ¡Œé¢ Chromeï¼‰</h1>
        <div class="small">
          <span class="pill" id="statusPill">æœªè¿æ¥</span>
          <span class="pill">å¤–æ¥ç”µæºï½œTX/RX äº¤å‰ï½œGND å…±åœ°</span>
        </div>
      </div>

      <div class="rightConnect">
        <label class="small">æ³¢ç‰¹ç‡ <input id="baud" class="mini" inputmode="numeric"/></label>
        <button class="btn" id="btnConnect">è¿æ¥ä¸²å£</button>
        <button class="btn" id="btnDisconnect" disabled>æ–­å¼€</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <h2>æˆ‘çš„åº—é“º / è´­ä¹°é“¾æ¥</h2>
      <div class="qrWrap">
        <img class="qr" src="qr.png" alt="åº—é“ºäºŒç»´ç ï¼ˆè¯·æ›¿æ¢ qr.pngï¼‰" />
        <div>
          <div class="muted small">æ‰«ç è¿›å…¥åº—é“º / è·å–é…å¥—ç¡¬ä»¶</div>
          <div style="margin:6px 0 10px">
            <a id="shopLink" href="https://example.com" target="_blank" rel="noopener">https://example.com</a>
          </div>
          <button class="btn" id="btnCopyLink">å¤åˆ¶é“¾æ¥</button>
          <div class="small muted" style="margin-top:8px">æç¤ºï¼šä½ å¯ä»¥æŠŠåŸŸåæ”¹æˆè‡ªå·±çš„ï¼Œå¹¶æ›¿æ¢äºŒç»´ç å›¾ç‰‡ã€‚</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(127,127,127,.2);margin:14px 0">

      <h2>å¸¸ç”¨åŠŸèƒ½</h2>
      <div class="row small">
        <label style="display:flex;gap:10px;align-items:center"><input id="posEnable" type="checkbox" disabled/>è‡ªåŠ¨åˆ·æ–°ä½ç½®/åœ¨çº¿</label>
        <label>åˆ·æ–°ms <input id="posPeriod" class="mini" inputmode="numeric"/></label>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnOpenScan">æ‰«æèˆµæœº</button>
        <button class="btn" id="btnOpenPipeline">æµæ°´çº¿é…ç½®</button>
      </div>

      <div class="row small" style="margin-top:10px;justify-content:space-between">
        <label style="display:flex;gap:10px;align-items:center"><input id="safeOneServo" type="checkbox"/>å†™æ“ä½œå‰æé†’â€œä¸€æ¬¡åªæ¥1ä¸ªèˆµæœºâ€</label>
      </div>

      <p class="small warn" style="margin:10px 0 0">
        Web Serial ä»…åœ¨ HTTPSï¼ˆæˆ– http://localhostï¼‰å¯ç”¨ï¼›è¯·ä½¿ç”¨æ¡Œé¢ Chrome/Edgeã€‚
      </p>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <h2 style="margin:0">åœ¨çº¿èˆµæœºåˆ—è¡¨</h2>
        <span class="spacer"></span>
        <span class="pill" id="scanState">æœªæ‰«æ</span>
        <span class="pill" id="posState">æœªè¿è¡Œ</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th><th>åœ¨çº¿</th><th>ä½ç½®(0x38)</th><th>æ›´æ–°æ—¶é—´</th>
            <th>æ”¹ID</th><th>ä¸­å€¼</th><th>RESET</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <p class="small muted" style="margin:10px 0 0">
        å»ºè®®ï¼šå…ˆâ€œæ‰«æèˆµæœºâ€ï¼Œå†æ‰“å¼€â€œè‡ªåŠ¨åˆ·æ–°ä½ç½®/åœ¨çº¿â€ã€‚æ”¹ID/å†™40=128/RESET éƒ½åœ¨æ¯è¡Œé‡Œå®Œæˆã€‚
        åˆ·æ–°ç½‘é¡µä¼šä»æœ¬åœ°å­˜å‚¨æ¢å¤è¾“å…¥ä¸è¡¨æ ¼ï¼ˆä½†ä¸²å£éœ€é‡æ–°è¿æ¥æˆæƒï¼‰ã€‚
      </p>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">æ—¥å¿—</h2>
      <button class="btn" id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    <pre id="log"></pre>
  </div>

  <dialog id="dlgScan">
    <div class="modal">
      <div class="modalHeader">
        <strong>æ‰«æèˆµæœº</strong>
        <button class="btn" id="btnCloseScan">å…³é—­</button>
      </div>
      <div class="modalGrid">
        <label>æ‰«æèµ·å§‹ID <input id="scanStart" inputmode="numeric"/></label>
        <label>æ‰«æç»“æŸID <input id="scanEnd" inputmode="numeric"/></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnScanOnce" disabled>æ‰«æä¸€æ¬¡</button>
        <span class="small muted">æ‰«æåªæŠŠåœ¨çº¿èˆµæœºåŠ å…¥è¡¨æ ¼ã€‚</span>
      </div>
    </div>
  </dialog>

  <dialog id="dlgPipeline">
    <div class="modal">
      <div class="modalHeader">
        <strong>æµæ°´çº¿é…ç½®ï¼ˆè‡ªåŠ¨ç›‘æ§æ’æ‹”ï¼‰</strong>
        <button class="btn" id="btnClosePipeline">å…³é—­</button>
      </div>
      <div class="modalGrid">
        <label>èµ·å§‹ID <input id="pipeStart" inputmode="numeric"/></label>
        <label>ç»“æŸID <input id="pipeEnd" inputmode="numeric"/></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnPipeStart" disabled>å¼€å§‹æµæ°´çº¿</button>
        <button class="btn" id="btnPipeStop" disabled>ä¸­æ–­</button>
        <span class="pill" id="pipeState">æœªè¿è¡Œ</span>
      </div>
      <p class="small muted" style="margin-top:10px">
        æµæ°´çº¿ä½¿ç”¨å¹¿æ’­æ¢æµ‹æ’å…¥ï¼ˆPING 0xFEï¼‰+ å¹¿æ’­å†™å…¥ï¼Œè¯·ç¡®ä¿ä»»æ„æ—¶åˆ»æ€»çº¿ä¸Šåªæœ‰ 1 ä¸ªèˆµæœºã€‚
      </p>
    </div>
  </dialog>

<script>
(() => {
  const BROADCAST_ID = 0xFE;
  const ADDR_ID     = 0x05;
  const ADDR_LOCK   = 0x37;
  const ADDR_TORQUE = 0x28; // 40

  const LS_KEY = "servo_tool_state_v8_1";
  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch{ return {}; } }
  function saveState(partial){ const cur=loadState(); localStorage.setItem(LS_KEY, JSON.stringify(Object.assign({}, cur, partial))); }

  let port=null, writer=null, reader=null, readLoopRunning=false;
  let rxBuf=[];

  let opChain = Promise.resolve();
  function withLock(fn){ const next = opChain.then(fn, fn); opChain = next.catch(()=>{}); return next; }

  const devices = new Map();

  const logEl = document.getElementById('log');
  const statusPill = document.getElementById('statusPill');
  const btnConnect = document.getElementById('btnConnect');
  const btnDisconnect = document.getElementById('btnDisconnect');
  const baudEl = document.getElementById('baud');

  const safeOneServoEl = document.getElementById('safeOneServo');

  const posEnableEl = document.getElementById('posEnable');
  const posPeriodEl = document.getElementById('posPeriod');
  const posStateEl = document.getElementById('posState');
  const scanStateEl = document.getElementById('scanState');

  const tbody = document.getElementById('tbody');
  const btnClearLog = document.getElementById('btnClearLog');

  const dlgScan = document.getElementById('dlgScan');
  const dlgPipeline = document.getElementById('dlgPipeline');
  const btnOpenScan = document.getElementById('btnOpenScan');
  const btnOpenPipeline = document.getElementById('btnOpenPipeline');
  const btnCloseScan = document.getElementById('btnCloseScan');
  const btnClosePipeline = document.getElementById('btnClosePipeline');

  const scanStartEl = document.getElementById('scanStart');
  const scanEndEl = document.getElementById('scanEnd');
  const btnScanOnce = document.getElementById('btnScanOnce');

  const pipeStartEl = document.getElementById('pipeStart');
  const pipeEndEl = document.getElementById('pipeEnd');
  const btnPipeStart = document.getElementById('btnPipeStart');
  const btnPipeStop = document.getElementById('btnPipeStop');
  const pipeStateEl = document.getElementById('pipeState');

  const shopLinkEl = document.getElementById('shopLink');
  const btnCopyLink = document.getElementById('btnCopyLink');

  function setStatus(text, kind="") {
    statusPill.textContent = text;
    statusPill.className = "pill " + kind;
  }
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ---- Persist / Restore ----
  function restoreFromLocalStorage(){
    const s = loadState();
    baudEl.value = String(s.baud ?? 1000000);
    safeOneServoEl.checked = !!(s.safeOneServo ?? true);
    scanStartEl.value = String(s.scanStart ?? 1);
    scanEndEl.value = String(s.scanEnd ?? 20);
    posEnableEl.checked = !!(s.posEnable ?? true);
    posPeriodEl.value = String(s.posPeriod ?? 50);
    pipeStartEl.value = String(s.pipeStart ?? 1);
    pipeEndEl.value = String(s.pipeEnd ?? 6);
    if (typeof s.shopUrl === "string" && s.shopUrl.trim()) {
      shopLinkEl.href = s.shopUrl.trim();
      shopLinkEl.textContent = s.shopUrl.trim();
    }

    const ids = Array.isArray(s.ids) ? s.ids : [];
    for (const id of ids) {
      if (!Number.isFinite(id)) continue;
      ensureDevice(id);
      const rowState = (s.rowState && s.rowState[String(id)]) ? s.rowState[String(id)] : null;
      if (rowState && typeof rowState.newIdInput === "string") {
        devices.get(id).row.input.value = rowState.newIdInput;
      }
      updateRow(id);
    }
    scanStateEl.textContent = ids.length ? `ä¸Šæ¬¡åœ¨çº¿ï¼š${ids.length} ä¸ªï¼ˆæœªé‡æ–°æ‰«æï¼‰` : "æœªæ‰«æ";
  }
  function persistInputs(){
    saveState({
      baud: Number(baudEl.value||1000000),
      safeOneServo: safeOneServoEl.checked,
      scanStart: Number(scanStartEl.value||1),
      scanEnd: Number(scanEndEl.value||20),
      posEnable: posEnableEl.checked,
      posPeriod: Number(posPeriodEl.value||50),
      pipeStart: Number(pipeStartEl.value||1),
      pipeEnd: Number(pipeEndEl.value||6),
      shopUrl: shopLinkEl.textContent || shopLinkEl.href
    });
  }
  function persistTableState(){
    const ids = Array.from(devices.keys()).sort((a,b)=>a-b);
    const rowState = {};
    for (const id of ids){
      const d = devices.get(id);
      if (d.row) rowState[String(id)] = { newIdInput: d.row.input.value || "" };
    }
    saveState({ ids, rowState });
  }
  [baudEl, safeOneServoEl, scanStartEl, scanEndEl, posEnableEl, posPeriodEl, pipeStartEl, pipeEndEl].forEach(el=>{
    el.addEventListener("change", () => persistInputs());
  });

  // ---- Protocol ----
  function calcChecksum(dataBytes) {
    let sum=0;
    for (const b of dataBytes) sum += (b & 0xFF);
    return (~sum) & 0xFF;
  }
  function buildPacket(dataBytes) {
    const chk = calcChecksum(dataBytes);
    return new Uint8Array([0xFF, 0xFF, ...dataBytes, chk]);
  }
  function verifyFrameChecksum(frame){
    if (!frame || frame.length < 6) return false;
    const len = frame[3];
    const total = 2 + 1 + 1 + len;
    if (frame.length !== total) return false;
    const dataBytes = frame.slice(2, frame.length - 1);
    const chk = calcChecksum(dataBytes);
    return chk === frame[frame.length - 1];
  }

  async function ensureWriter(){
    if (!port) throw new Error("æœªè¿æ¥ä¸²å£");
    if (!writer) writer = port.writable.getWriter();
  }
  async function writeRaw(u8){ await ensureWriter(); await writer.write(u8); }

  async function startReadLoop(){
    reader = port.readable.getReader();
    readLoopRunning = true;
    rxBuf = [];
    (async () => {
      try{
        while (readLoopRunning){
          const {value, done} = await reader.read();
          if (done) break;
          if (value && value.length){
            for (const b of value) rxBuf.push(b);
            if (rxBuf.length > 8192) rxBuf = rxBuf.slice(-4096);
          }
        }
      } catch(e) {
        log(`è¯»å–å¼‚å¸¸: ${e.message || e}`);
      }
    })();
  }
  async function stopReadLoop(){
    readLoopRunning = false;
    if (reader){ try{ await reader.cancel(); }catch{} try{ reader.releaseLock(); }catch{} reader=null; }
    rxBuf=[];
  }

  function tryPopFrame(){
    for (let i=0; i+6<=rxBuf.length; i++){
      if (rxBuf[i]!==0xFF || rxBuf[i+1]!==0xFF) continue;
      const len = rxBuf[i+3];
      const total = 2 + 1 + 1 + len;
      if (i+total > rxBuf.length) return null;
      const frame = rxBuf.slice(i, i+total);
      rxBuf = rxBuf.slice(i+total);
      if (!verifyFrameChecksum(frame)) continue;
      return frame;
    }
    if (rxBuf.length > 4096) rxBuf = rxBuf.slice(-1024);
    return null;
  }

  async function waitFrame(expectedId, timeoutMs){
    const start = performance.now();
    while (performance.now() - start < timeoutMs){
      const fr = tryPopFrame();
      if (!fr){ await sleep(1); continue; }
      const id = fr[2];
      if (expectedId == null || id === expectedId) return fr;
    }
    return null;
  }

  async function ping(id, timeoutMs=90){
    return withLock(async () => {
      rxBuf = [];
      await writeRaw(buildPacket([id & 0xFF, 0x02, 0x01]));
      return !!(await waitFrame(id, timeoutMs));
    });
  }
  async function pingBroadcastAny(timeoutMs=90){
    return withLock(async () => {
      rxBuf = [];
      await writeRaw(buildPacket([BROADCAST_ID, 0x02, 0x01]));
      return !!(await waitFrame(null, timeoutMs));
    });
  }
  async function writeReg(id, address, value){
    return withLock(async () => {
      rxBuf = [];
      await writeRaw(buildPacket([id & 0xFF, 0x04, 0x03, address & 0xFF, value & 0xFF]));
      await sleep(45);
    });
  }
  async function readReg(id, address, size, timeoutMs=35){
    return withLock(async () => {
      rxBuf = [];
      await writeRaw(buildPacket([id & 0xFF, 0x04, 0x02, address & 0xFF, size & 0xFF]));
      const fr = await waitFrame(id, timeoutMs);
      if (!fr) return null;
      if (fr[4] !== 0) return null;
      const paramsLen = fr[3] - 2;
      return fr.slice(5, 5 + paramsLen);
    });
  }

  async function changeIdTargeted(oldId, newId){
    oldId = Number(oldId); newId = Number(newId);
    await writeReg(oldId, ADDR_LOCK, 0);
    await writeReg(oldId, ADDR_TORQUE, 0);
    await writeReg(oldId, ADDR_ID, newId);
    await sleep(150);
    await writeReg(newId, ADDR_LOCK, 1);

    let ok = await ping(newId, 160);
    if (!ok){ await sleep(250); ok = await ping(newId, 160); }
    if (!ok) throw new Error("éªŒè¯å¤±è´¥");
  }
  async function changeIdBroadcastLikeScript(newId){
    newId = Number(newId);
    await writeReg(BROADCAST_ID, ADDR_LOCK, 0);
    await writeReg(BROADCAST_ID, ADDR_TORQUE, 0);
    await writeReg(BROADCAST_ID, ADDR_ID, newId);
    await sleep(150);
    await writeReg(newId, ADDR_LOCK, 1);

    let ok = await ping(newId, 160);
    if (!ok){ await sleep(250); ok = await ping(newId, 160); }
    if (!ok) throw new Error("éªŒè¯å¤±è´¥");
  }

  async function writeMiddleCalibrate(id){ await writeReg(id, 0x28, 128); }
  async function resetState(id){
    return withLock(async () => {
      rxBuf = [];
      await writeRaw(buildPacket([id & 0xFF, 0x02, 0x0A]));
      await sleep(55);
    });
  }

  // ---- Table ----
  function ensureDevice(id){
    if (!devices.has(id)) devices.set(id, {online:false, pos:null, ts:null, failCount:0, row:null});
    ensureRow(id);
  }
  function ensureRow(id){
    const d = devices.get(id);
    if (d.row) return d.row;

    const tr = document.createElement("tr"); tr.dataset.id = String(id);

    const tdId = document.createElement("td"); tdId.textContent = String(id);
    const tdOnline = document.createElement("td");
    const tdPos = document.createElement("td");
    const tdTs = document.createElement("td");

    const tdChange = document.createElement("td");
    const input = document.createElement("input"); input.className="mini"; input.inputMode="numeric"; input.placeholder="æ–°ID";
    const btnChange = document.createElement("button"); btnChange.className="btn"; btnChange.textContent="æ”¹ID"; btnChange.dataset.action="change"; btnChange.dataset.id=String(id);
    tdChange.append(input, document.createTextNode(" "), btnChange);

    const tdMid = document.createElement("td");
    const btnMid = document.createElement("button"); btnMid.className="btn"; btnMid.textContent="å†™40=128"; btnMid.dataset.action="mid"; btnMid.dataset.id=String(id);
    tdMid.append(btnMid);

    const tdRst = document.createElement("td");
    const btnRst = document.createElement("button"); btnRst.className="btn"; btnRst.textContent="RESET"; btnRst.dataset.action="rst"; btnRst.dataset.id=String(id);
    tdRst.append(btnRst);

    tr.append(tdId, tdOnline, tdPos, tdTs, tdChange, tdMid, tdRst);
    tbody.append(tr);

    input.addEventListener("input", () => persistTableState());
    d.row = {tr, tdOnline, tdPos, tdTs, input, btnChange, btnMid, btnRst};
    return d.row;
  }
  function updateRow(id){
    const d = devices.get(id); if (!d || !d.row) return;
    d.row.tdOnline.textContent = d.online ? "âœ…" : "";
    d.row.tdPos.textContent = (d.pos ?? "");
    d.row.tdTs.textContent = d.ts ? new Date(d.ts).toLocaleTimeString() : "";
    const dis = !d.online || !port;
    d.row.btnChange.disabled = dis;
    d.row.btnMid.disabled = dis;
    d.row.btnRst.disabled = dis;
  }
  function removeRow(id){
    const d = devices.get(id);
    if (d && d.row && d.row.tr) d.row.tr.remove();
    devices.delete(id);
  }

  tbody.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button");
    if (!btn) return;
    const action = btn.dataset.action;
    const id = Number(btn.dataset.id);
    if (!port) return;

    try{
      if (safeOneServoEl.checked){
        const ok = confirm("å†™æ“ä½œå‰ç¡®è®¤ï¼šå½“å‰æ€»çº¿ä¸Šåªæœ‰ 1 ä¸ªèˆµæœºï¼Ÿ\nï¼ˆå•è¡Œæ”¹IDä¸ºå®šå‘å†™ï¼Œä½†ä»å»ºè®®åªæ¥1ä¸ªã€‚ï¼‰");
        if (!ok) return;
      }
      btn.disabled = true;

      const d = devices.get(id);
      if (!d || !d.online) throw new Error("å½“å‰èˆµæœºä¸åœ¨çº¿");

      if (action === "change"){
        const newId = Number(d.row.input.value);
        if (!Number.isFinite(newId)) throw new Error("è¯·è¾“å…¥æ–°ID");
        log(`æ”¹IDï¼ˆå®šå‘ï¼‰ï¼š${id} -> ${newId}`);
        await changeIdTargeted(id, newId);
        log("âœ… æ”¹IDæˆåŠŸ");
        removeRow(id);
        ensureDevice(newId);
        devices.get(newId).online = true;
        devices.get(newId).ts = Date.now();
        updateRow(newId);
        persistTableState();
      } else if (action === "mid"){
        log(`å†™40=128ï¼šID=${id}`);
        await writeMiddleCalibrate(id);
        log("âœ… å†™å…¥å®Œæˆ");
      } else if (action === "rst"){
        log(`RESETï¼šID=${id}`);
        await resetState(id);
        log("âœ… å·²å‘é€ RESET");
      }
    } catch(e) {
      log(`æ“ä½œå¤±è´¥: ${e.message || e}`);
    } finally {
      btn.disabled = false;
    }
  });

  // ---- Scan (modal) ----
  async function scanOnce(){
    const start = Number(scanStartEl.value);
    const end = Number(scanEndEl.value);
    if (!Number.isFinite(start)||!Number.isFinite(end)||start<1||end>253||start>end){
      alert("æ‰«æèŒƒå›´ä¸åˆæ³•ï¼ˆ1~253 ä¸” èµ·å§‹<=ç»“æŸï¼‰");
      return;
    }
    scanStateEl.textContent = "æ‰«æä¸­...";

    const onlineIds = [];
    for (let id=start; id<=end; id++) {
      const ok = await ping(id, 70);
      if (ok) onlineIds.push(id);
    }

    tbody.innerHTML = "";
    devices.clear();
    for (const id of onlineIds) {
      ensureDevice(id);
      const d = devices.get(id);
      d.online = true;
      d.ts = Date.now();
      updateRow(id);
    }

    scanStateEl.textContent = `åœ¨çº¿ï¼š${onlineIds.length} ä¸ª`;
    persistInputs();
    persistTableState();
    if (posEnableEl.checked) ensurePosLoop();
    dlgScan.close();
  }

  // ---- Position loop ----
  const failThreshold = 3;
  let posLoopRunning=false;
  async function posLoop(){
    posLoopRunning = true;
    posStateEl.textContent = "è¿è¡Œä¸­";
    while (posLoopRunning && port){
      const cycleStart = performance.now();
      const period = Math.max(20, Number(posPeriodEl.value)||50);

      const ids = Array.from(devices.keys());
      for (const id of ids){
        const d = devices.get(id);
        if (!d) continue;

        const params = await readReg(id, 0x38, 2, 30);
        if (!params || params.length < 2){
          d.failCount = (d.failCount || 0) + 1;
          if (d.failCount >= failThreshold){ d.online=false; d.pos=null; }
          updateRow(id);
          continue;
        }
        const pos = params[0] | (params[1]<<8);
        d.pos = pos;
        d.ts = Date.now();
        d.failCount = 0;
        d.online = true;
        updateRow(id);
      }

      const elapsed = performance.now() - cycleStart;
      const rest = Math.max(0, period - elapsed);
      if (rest) await sleep(rest); else await sleep(0);
    }
    posStateEl.textContent = "å·²åœæ­¢";
  }
  function ensurePosLoop(){ if (!posEnableEl.checked || !port) return; if (posLoopRunning) return; posLoop(); }
  function stopPosLoop(){ posLoopRunning=false; }

  posEnableEl.addEventListener("change", () => {
    persistInputs();
    if (posEnableEl.checked) ensurePosLoop();
    else stopPosLoop();
  });

  // ---- Pipeline (modal) ----
  let pipeRunning=false;
  let pipeTarget=1, pipeStart=1, pipeEnd=6;
  let pipeState="IDLE";
  let insertSeenCount=0;
  let removeLostSince=null;

  async function pipeLoop(){
    while (pipeRunning && port){
      const stepDelay = 80;
      try{
        if (pipeState === "WAIT_INSERT"){
          const seen = await pingBroadcastAny(80);
          insertSeenCount = seen ? (insertSeenCount + 1) : 0;
          if (insertSeenCount >= 3){
            pipeState = "PROGRAMMING";
            pipeStateEl.textContent = `æ£€æµ‹åˆ°æ’å…¥ï¼Œé…ç½® ID=${pipeTarget}...`;
            insertSeenCount = 0;
          } else {
            pipeStateEl.textContent = `ç­‰å¾…æ’å…¥ï¼ˆç›®æ ‡ ID=${pipeTarget}ï¼‰...`;
          }
        } else if (pipeState === "PROGRAMMING"){
          await changeIdBroadcastLikeScript(pipeTarget);
          log(`âœ… æµæ°´çº¿å†™å…¥æˆåŠŸï¼šID=${pipeTarget}`);
          pipeState = "WAIT_REMOVE";
          removeLostSince = null;
          pipeStateEl.textContent = `å·²å†™å…¥ ID=${pipeTarget}ï¼Œè¯·æ‹”æ‰èˆµæœº...`;
        } else if (pipeState === "WAIT_REMOVE"){
          const online = await ping(pipeTarget, 90);
          if (online){ removeLostSince = null; }
          else {
            if (removeLostSince == null) removeLostSince = performance.now();
            if (performance.now() - removeLostSince >= 1000){
              if (pipeTarget >= pipeEnd){
                log(`ğŸ‰ æµæ°´çº¿å®Œæˆï¼š${pipeStart}~${pipeEnd}`);
                pipeStateEl.textContent = `å®Œæˆï¼š${pipeStart}~${pipeEnd}`;
                pipeRunning = false;
              } else {
                pipeTarget += 1;
                pipeState = "WAIT_INSERT";
                insertSeenCount = 0;
                removeLostSince = null;
                log(`è¯·æ’å…¥ä¸‹ä¸€åªèˆµæœºï¼Œç›®æ ‡ ID=${pipeTarget}`);
              }
            }
          }
        }
      } catch(e) {
        log(`æµæ°´çº¿å¼‚å¸¸: ${e.message || e}`);
        pipeRunning = false;
        pipeStateEl.textContent = "å¼‚å¸¸åœæ­¢";
      }
      await sleep(stepDelay);
    }
    btnPipeStart.disabled = !port;
    btnPipeStop.disabled = true;
    if (!pipeStateEl.textContent.startsWith("å®Œæˆ") && pipeStateEl.textContent !== "å¼‚å¸¸åœæ­¢") pipeStateEl.textContent = "æœªè¿è¡Œ";
  }

  function startPipeline(){
    pipeStart = Number(pipeStartEl.value);
    pipeEnd = Number(pipeEndEl.value);
    if (!Number.isFinite(pipeStart) || !Number.isFinite(pipeEnd) || pipeStart<1 || pipeEnd>253 || pipeStart>pipeEnd){
      alert("æµæ°´çº¿èŒƒå›´ä¸åˆæ³•ï¼ˆ1~253 ä¸” èµ·å§‹<=ç»“æŸï¼‰");
      return;
    }
    if (safeOneServoEl.checked){
      const ok = confirm("æµæ°´çº¿æ¨¡å¼ä¼šä½¿ç”¨å¹¿æ’­æ¢æµ‹ä¸å¹¿æ’­å†™å…¥ã€‚\nè¯·ç¡®è®¤ï¼šä»»æ„æ—¶åˆ»æ€»çº¿ä¸Šåªæœ‰ 1 ä¸ªèˆµæœºã€‚");
      if (!ok) return;
    }
    persistInputs();
    pipeRunning = true;
    pipeTarget = pipeStart;
    pipeState = "WAIT_INSERT";
    insertSeenCount = 0;
    removeLostSince = null;
    btnPipeStart.disabled = true;
    btnPipeStop.disabled = false;
    pipeStateEl.textContent = `ç­‰å¾…æ’å…¥ï¼ˆç›®æ ‡ ID=${pipeTarget}ï¼‰...`;
    log(`æµæ°´çº¿å¯åŠ¨ï¼šå°†é…ç½® ID=${pipeStart}~${pipeEnd}ã€‚è¯·æ’å…¥ç¬¬ä¸€åªèˆµæœº...`);
    pipeLoop();
  }
  function stopPipeline(){
    pipeRunning = false;
    btnPipeStart.disabled = !port;
    btnPipeStop.disabled = true;
    pipeStateEl.textContent = "æœªè¿è¡Œ";
    log("æµæ°´çº¿å·²ä¸­æ–­");
  }

  // ---- Connect ----
  function setUiConnected(connected){
    btnConnect.disabled = connected;
    btnDisconnect.disabled = !connected;
    baudEl.disabled = connected;

    btnScanOnce.disabled = !connected;
    btnPipeStart.disabled = !connected;
    btnPipeStop.disabled = true;

    posEnableEl.disabled = !connected;

    if (!connected) setStatus("æœªè¿æ¥");
    else setStatus("å·²è¿æ¥", "ok");

    for (const id of devices.keys()) updateRow(id);
  }

  btnConnect.onclick = async () => {
    try{
      if (!("serial" in navigator)){ alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Serialã€‚è¯·ä½¿ç”¨æ¡Œé¢ç‰ˆ Chrome/Edgeã€‚"); return; }
      const baudRate = Number(baudEl.value || "1000000");
      if (!Number.isFinite(baudRate) || baudRate<=0){ alert("æ³¢ç‰¹ç‡ä¸åˆæ³•"); return; }

      port = await navigator.serial.requestPort();
      await port.open({ baudRate });
      await startReadLoop();

      setUiConnected(true);
      log(`å·²è¿æ¥ä¸²å£ï¼Œbaud=${baudRate}`);
      if (posEnableEl.checked) ensurePosLoop();
    } catch(e) {
      log(`è¿æ¥å¤±è´¥: ${e.message || e}`);
      setUiConnected(false);
      port = null;
    }
  };

  btnDisconnect.onclick = async () => {
    try{
      stopPipeline();
      stopPosLoop();
      await stopReadLoop();
      if (writer){ try{ writer.releaseLock(); } catch{} writer=null; }
      if (port){ await port.close(); }
      port=null;
      setUiConnected(false);
      log("å·²æ–­å¼€ä¸²å£");
    } catch(e) {
      log(`æ–­å¼€å¤±è´¥: ${e.message || e}`);
    }
  };

  // ---- UI events ----
  btnOpenScan.onclick = () => dlgScan.showModal();
  btnOpenPipeline.onclick = () => dlgPipeline.showModal();
  btnCloseScan.onclick = () => dlgScan.close();
  btnClosePipeline.onclick = () => dlgPipeline.close();
  btnScanOnce.onclick = () => scanOnce().catch(e=>log(`æ‰«æå¤±è´¥: ${e.message||e}`));
  btnPipeStart.onclick = () => startPipeline();
  btnPipeStop.onclick = () => stopPipeline();
  btnClearLog.onclick = () => { logEl.textContent = ""; };

  btnCopyLink.onclick = async () => {
    try{
      const url = shopLinkEl.textContent || shopLinkEl.href;
      await navigator.clipboard.writeText(url);
      log("å·²å¤åˆ¶åº—é“ºé“¾æ¥");
    } catch {
      log("å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨å¯èƒ½é˜»æ­¢å‰ªè´´æ¿æƒé™");
    }
  };

  // ---- Boot ----
  restoreFromLocalStorage();
  persistInputs();
  setUiConnected(false);
})();
</script>
</body>
</html>
